## Урок 23

1. **news/templates/news/add_article.html**:
   - **Добавление формы для загрузки JSON-файла**: Добавлена новая форма для загрузки JSON-файла. Форма отправляется методом POST и содержит поле для выбора файла и кнопку для загрузки. Это изменение сделано для предоставления пользователям возможности загружать статьи из JSON-файла.

2. **news/urls.py**:
   - **Добавление нового маршрута для загрузки JSON-файла**: Добавлен новый маршрут `path('upload_json/', views.upload_json, name='upload_json')` для обработки запросов на загрузку JSON-файла. Это изменение сделано для поддержки новой функциональности загрузки статей из JSON-файла.

3. **news/views.py**:
   - **Импорт модулей**: Добавлены импорты модулей `json`, `unidecode`, `models` и `slugify`. Эти модули необходимы для работы с JSON-файлами и генерации уникальных слагов.
   - **Добавление функции upload_json**: Добавлена новая функция `upload_json`, которая обрабатывает запросы на загрузку JSON-файла. Функция проверяет метод запроса (POST) и наличие файла в запросе. Если файл существует, он загружается и обрабатывается. Данные из файла загружаются и создаются новые статьи с уникальными слагами. Также добавляются теги к статьям. Если файл не является корректным JSON, возвращается ошибка. Это изменение сделано для реализации функциональности загрузки статей из JSON-файла.

### Объяснение, для чего нужны эти изменения и как работает этот код

**Загрузка JSON-файла**:
Загрузка JSON-файла позволяет пользователям легко добавлять несколько статей одновременно, используя данные в формате JSON. Это упрощает процесс добавления статей и позволяет быстро заполнить базу данных большим количеством статей.

**Как работает этот код**:

1. **Шаблон для добавления статьи (news/templates/news/add_article.html)**:
   - В шаблоне `add_article.html` добавлена новая форма для загрузки JSON-файла. Форма отправляется методом POST и содержит поле для выбора файла и кнопку для загрузки. Шаблон использует тег `{% csrf_token %}` для защиты от CSRF-атак.

2. **Маршрут для загрузки JSON-файла (news/urls.py)**:
   - Добавлен новый маршрут `path('upload_json/', views.upload_json, name='upload_json')` для обработки запросов на загрузку JSON-файла. Маршрут связывает URL `/upload_json/` с представлением `upload_json`.

3. **Представление для загрузки JSON-файла (news/views.py)**:
   - Функция `upload_json` обрабатывает запросы на загрузку JSON-файла. Она проверяет метод запроса (POST) и наличие файла в запросе. Если файл существует, он загружается и обрабатывается. Данные из файла загружаются и создаются новые статьи с уникальными слагами. Также добавляются теги к статьям. Если файл не является корректным JSON, возвращается ошибка.

**Почему сначала создаётся статья, а только потом добавляются теги**:
Сначала создаётся статья, чтобы получить её идентификатор и уникальный слаг. После этого теги добавляются к уже созданной статье. Это позволяет избежать проблем с целостностью данных и обеспечивает корректное связывание данных в базе данных.

**commit: `Урок 23: добавили возможность добавления нескольких статей из json-файла`**

### Обзор изменений

1. **Создание формы для валидации данных из JSON-файла.**
2. **Обновление представления `upload_json` для использования этой формы.**
3. **Обновление шаблона для отображения сообщений об ошибках.**

### Подробное объяснение

#### 1. Создание формы для валидации данных из JSON-файла
Создана форма `ArticleUploadForm`, которая включает поле для загрузки JSON-файла и методы для валидации данных из этого файла.

- **`json_file`**: Поле для загрузки JSON-файла.
- **`clean_json_file`**: Метод для валидации загруженного файла. Проверяет, что файл имеет расширение `.json`.
- **`validate_json_data`**: Метод для валидации данных из JSON-файла. Проверяет, что категории и теги, указанные в файле, существуют в базе данных. Если категория или тег не существует, добавляет сообщение об ошибке в список `errors`.

#### 2. Обновление представления `upload_json` для использования этой формы
Обновлено представление `upload_json`, чтобы использовать форму `ArticleUploadForm` для валидации данных из JSON-файла.

- **`upload_json`**: Представление для обработки загрузки JSON-файла.
  - Проверяет, что запрос является POST-запросом.
  - Использует форму `ArticleUploadForm` для валидации загруженного файла.
  - Если файл валиден, загружает данные из файла и вызывает метод `validate_json_data` для валидации данных.
  - Если есть ошибки валидации, отображает их пользователю.
  - Если данные валидны, создает новые статьи и добавляет к ним теги.

#### 3. Обновление шаблона для отображения сообщений об ошибках
Обновлён шаблон `add_article.html`, чтобы отображать сообщения об ошибках, если категория или тег не существует.

- **`add_article.html`**: Шаблон для добавления новой статьи.
  - Отображает форму для загрузки JSON-файла.
  - Если есть ошибки валидации, отображает их пользователю.
  - Отображает форму для добавления новой статьи.

**commit: `Урок 23: валидация категорий и тегов`**

1. **news/forms.py**:
   - **Изменение виджетов и меток полей формы ArticleForm**: В форме `ArticleForm` изменены виджеты и метки полей `title`, `content`, `category` и `image`. Эти изменения сделаны для улучшения пользовательского опыта и удобства заполнения формы.
   - **Добавление формы ArticleUploadForm**: Добавлена новая форма `ArticleUploadForm` для загрузки JSON-файла. Форма содержит поле `json_file` с виджетом `FileInput` и меткой "Загрузить JSON-файл". Это изменение сделано для предоставления пользователям возможности загружать статьи из JSON-файла.

2. **news/templates/news/add_article.html**:
   - **Изменение структуры шаблона**: Удалены лишние контейнеры и добавлены новые элементы для улучшения структуры и визуального оформления шаблона.
   - **Добавление формы для загрузки JSON-файла**: Добавлена новая форма для загрузки JSON-файла. Форма отправляется методом POST и содержит поле для выбора файла и кнопку для загрузки. Это изменение сделано для предоставления пользователям возможности загружать статьи из JSON-файла.
   - **Изменение отображения полей формы**: В цикле `{% for field in form %}` изменено отображение полей формы. Теперь каждое поле отображается в элементе `<div class="mb-3">` с меткой и самим полем. Если у поля есть ошибки, они отображаются в элементе `<div class="alert alert-danger mt-2">`. Это изменение сделано для улучшения визуального оформления и удобства пользователей.
   - **Добавление кнопок "Опубликовать" и "Отмена"**: Добавлены кнопки "Опубликовать" и "Отмена" для улучшения пользовательского опыта.

3. **templates/base.html**:
   - **Добавление стилей для тегов**: Добавлены новые стили для тегов. Эти стили используются для улучшения визуального оформления тегов в шаблонах.

**Как работает этот код**:

1. **Определение формы (news/forms.py)**:
   - Форма `ArticleForm` определена с использованием класса `forms.ModelForm`. Она содержит поля `title`, `content`, `category`, `tags` и `image`. Поля используют виджеты для улучшения пользовательского опыта и удобства заполнения формы.
   - Форма `ArticleUploadForm` содержит поле `json_file` с виджетом `FileInput` и меткой "Загрузить JSON-файл". Это позволяет пользователям загружать статьи из JSON-файла.

2. **Шаблон для добавления статьи (news/templates/news/add_article.html)**:
   - Шаблон `add_article.html` расширяет базовый шаблон и содержит форму для добавления новой статьи. Форма отправляется методом POST и содержит кнопки "Опубликовать" и "Отмена". Шаблон использует тег `{% csrf_token %}` для защиты от CSRF-атак.
   - В шаблоне добавлена новая форма для загрузки JSON-файла. Форма отправляется методом POST и содержит поле для выбора файла и кнопку для загрузки.
   - В цикле `{% for field in form %}` изменено отображение полей формы. Теперь каждое поле отображается в элементе `<div class="mb-3">` с меткой и самим полем. Если у поля есть ошибки, они отображаются в элементе `<div class="alert alert-danger mt-2">`.

3. **Базовый шаблон (templates/base.html)**:
   - В базовый шаблон добавлены новые стили для тегов. Эти стили используются для улучшения визуального оформления тегов в шаблонах.

### Список используемых тегов и стилей с их описанием

1. **HTML теги**:
   - `<form>`: Форма для отправки данных.
   - `<input>`: Поле ввода для формы.
   - `<button>`: Кнопка для отправки формы.
   - `<label>`: Метка для поля формы.
   - `<div>`: Контейнер для группировки элементов.
   - `<i>`: Иконка для визуального оформления.
   - `{% csrf_token %}`: Тег для защиты от CSRF-атак.
   - `{% extends "base.html" %}`: Тег для расширения базового шаблона.
   - `{% block content %}`: Тег для определения блока контента.
   - `{% endblock %}`: Тег для завершения блока контента.
   - `{% for field in form %}`: Тег для цикла по полям формы.
   - `{% endfor %}`: Тег для завершения цикла.
   - `{% if field.errors %}`: Тег для условия проверки наличия ошибок у поля.
   - `{% endif %}`: Тег для завершения условия.

2. **Bootstrap классы**:
   - `form-group`: Группа полей формы.
   - `form-label`: Метка поля формы.
   - `form-control`: Стиль для текстового поля.
   - `form-select`: Стиль для выпадающего списка.
   - `form-control-file`: Стиль для поля загрузки файла.
   - `btn btn-success`: Стиль для кнопки загрузки.
   - `mt-2`: Отступ сверху.
   - `mt-4`: Отступ сверху.
   - `mb-3`: Отступ снизу.
   - `alert alert-danger`: Стиль для отображения ошибок.
   - `bi bi-upload`: Иконка загрузки.
   - `fw-bold`: Жирный шрифт.
   - `d-grid`: Флексбокс для горизонтального выравнивания.
   - `gap-2`: Отступ между элементами.
   - `d-md-flex`: Флексбокс для горизонтального выравнивания на средних и больших экранах.
   - `justify-content-md-end`: Выравнивание элементов по правому краю на средних и больших экранах.

3. **CSS стили**:
   - `.tag-list`: Стиль для списка тегов.
   - `.tag-item`: Стиль для элемента тега.
   - `background-color`: Цвет фона.
   - `border`: Граница.
   - `border-radius`: Закругленные углы.
   - `padding`: Внутренний отступ.
   - `font-size`: Размер шрифта.

**commit: `Урок 23: поправили вёрстку и стиль формы добавления статьи`**

#### Изменения в файле `news/forms.py`

##### Улучшение сообщений об ошибках
- **Изменение:** Обновлены сообщения об ошибках для категорий и тегов.
- **Цель:** Улучшение пользовательского опыта путем предоставления более информативных сообщений об ошибках.
- **Как работает:** В форме загрузки статьи теперь выводятся более детальные сообщения об ошибках, указывающие на несуществующие категории или теги и предлагающие варианты исправления.

#### Изменения в файле `news/models.py`

##### Обновление метода `save`
- **Изменение:** Удалены строки, связанные с отладочными сообщениями и повторным сохранением статьи. Добавлены строки для генерации уникального `slug`.
- **Цель:** Оптимизация процесса сохранения статьи и генерации уникального `slug`.
- **Как работает:** Теперь метод `save` генерирует уникальный `slug` на основе заголовка статьи и проверяет его уникальность перед сохранением. Это предотвращает дублирование `slug` и улучшает SEO.

#### Изменения в файле `news/templates/news/upload_json.html`

##### Создание нового шаблона для загрузки JSON-файла
- **Изменение:** Добавлен новый шаблон для загрузки JSON-файла.
- **Цель:** Предоставление пользовательского интерфейса для загрузки новостей из JSON-файла.
- **Как работает:** Новый шаблон включает форму для загрузки JSON-файла и отображение ошибок, если они возникают при загрузке.

#### Изменения в файле `news/urls.py`

##### Удаление комментария
- **Изменение:** Удален комментарий, связанный с новым URL для загрузки JSON-файла.
- **Цель:** Очистка кода от ненужных комментариев.
- **Как работает:** Удаление комментария не влияет на функциональность, но делает код чище.

#### Изменения в файле `news/views.py`

##### Обновление представления `upload_json`
- **Изменение:** Обновлен шаблон, используемый для отображения формы загрузки JSON-файла.
- **Цель:** Использование специализированного шаблона для загрузки JSON-файла.
- **Как работает:** Теперь представление `upload_json` использует шаблон `news/upload_json.html` для отображения формы и ошибок.

##### Обновление представления `add_article`
- **Изменение:** Обновлен метод сохранения статьи и контекст, передаваемый в шаблон.
- **Цель:** Улучшение процесса сохранения статьи и генерации `slug`.
- **Как работает:** Теперь статья сохраняется с использованием `commit=False`, чтобы сначала сгенерировать `slug`, а затем сохранить статью. Контекст, передаваемый в шаблон, упрощен.

### Общее объяснение работы кода

1. **Форма загрузки статьи (`news/forms.py`):**
   - Проверяет наличие категорий и тегов в загружаемой статье.
   - Обновленные сообщения об ошибках помогают пользователям исправить несуществующие категории или теги.

2. **Модель статьи (`news/models.py`):**
   - Метод `save` генерирует уникальный `slug` на основе заголовка статьи.
   - Проверяет уникальность `slug` перед сохранением статьи, чтобы избежать дублирования.

3. **Шаблон загрузки JSON-файла (`news/templates/news/upload_json.html`):**
   - Предоставляет интерфейс для загрузки новостей из JSON-файла.
   - Отображает ошибки, если они возникают при загрузке.

4. **Маршруты (`news/urls.py`):**
   - Определяет URL-адреса для различных действий, связанных с новостями, включая загрузку JSON-файла.

5. **Представления (`news/views.py`):**
   - Обрабатывает запросы на загрузку JSON-файла и добавление статьи.
   - Использует специализированные шаблоны для отображения форм и ошибок.
   - Оптимизирует процесс сохранения статьи и генерации `slug`.

**commit: `Урок 23: разделили одиночное и потоковое добавление статей`**

### Изменения в файле `news/templates/news/add_article.html`

#### Обновление заголовка и добавление кнопки загрузки JSON
- **Изменение:** Обновлен заголовок и добавлена кнопка для загрузки новостей из JSON-файла.
- **Цель:** Улучшение пользовательского интерфейса и предоставление возможности загрузки новостей из JSON-файла.
- **Как работает:** Теперь на странице добавления статьи есть кнопка для перехода к загрузке новостей из JSON-файла.

#### Удаление формы загрузки JSON-файла
- **Изменение:** Удалена форма для загрузки JSON-файла.
- **Цель:** Упрощение шаблона и перенос функциональности загрузки JSON-файла в отдельный шаблон.
- **Как работает:** Форма для загрузки JSON-файла была удалена из этого шаблона, чтобы упростить его и перенести функциональность в другой шаблон.

#### Обновление отображения тегов
- **Изменение:** Теги теперь отображаются в два столбца.
- **Цель:** Улучшение визуального отображения тегов для лучшей читаемости.
- **Как работает:** Теги теперь отображаются в два столбца, что делает их более удобными для чтения и редактирования.

### Изменения в файле `news/templates/news/edit_article_from_json.html`

#### Создание нового шаблона для редактирования статьи из JSON
- **Изменение:** Добавлен новый шаблон для редактирования статьи из JSON-файла.
- **Цель:** Предоставление пользовательского интерфейса для редактирования статьи из JSON-файла.
- **Как работает:** Новый шаблон включает форму для редактирования статьи и отображение ошибок, если они возникают при редактировании.

### Изменения в файле `news/templatetags/customtags.py`

#### Добавление фильтра `add`
- **Изменение:** Добавлен новый фильтр `add` для сложения двух чисел.
- **Цель:** Упрощение вычислений в шаблонах.
- **Как работает:** Фильтр `add` позволяет сложить два числа в шаблоне, что упрощает вычисления и делает код более читаемым.

### Изменения в файле `news/urls.py`

#### Обновление URL для загрузки JSON-файла
- **Изменение:** Обновлен URL для загрузки JSON-файла и добавлен новый URL для редактирования статьи из JSON.
- **Цель:** Предоставление отдельных URL для загрузки и редактирования статьи из JSON-файла.
- **Как работает:** Теперь есть отдельные URL для загрузки JSON-файла и редактирования статьи из JSON, что упрощает маршрутизацию и управление статьями.

### Изменения в файле `news/views.py`

#### Обновление представления `upload_json`
- **Изменение:** Обновлено представление для загрузки JSON-файла и добавлено новое представление для редактирования статьи из JSON.
- **Цель:** Улучшение функциональности загрузки и редактирования статьи из JSON-файла.
- **Как работает:** Теперь представление `upload_json_view` сохраняет данные в сессию для последовательного просмотра и редактирования статьи. Новое представление `edit_article_from_json` позволяет редактировать статью из JSON-файла.

#### Обновление представления `add_article`
- **Изменение:** Обновлен метод сохранения статьи и добавлена функция `save_article` для сохранения статьи.
- **Цель:** Улучшение процесса сохранения статьи и генерации `slug`.
- **Как работает:** Теперь статья сохраняется с использованием функции `save_article`, которая генерирует уникальный `slug` и сохраняет статью.

### Общее объяснение работы кода

1. **Шаблон добавления статьи (`news/templates/news/add_article.html`):**
   - Предоставляет интерфейс для добавления новой статьи.
   - Обновления включают добавление кнопки для загрузки новостей из JSON-файла и улучшение отображения тегов.

2. **Шаблон редактирования статьи из JSON (`news/templates/news/edit_article_from_json.html`):**
   - Предоставляет интерфейс для редактирования статьи из JSON-файла.
   - Включает форму для редактирования статьи и отображение ошибок.

3. **Фильтры шаблонов (`news/templatetags/customtags.py`):**
   - Предоставляет пользовательские фильтры для использования в шаблонах.
   - Новый фильтр `add` упрощает вычисления в шаблонах.

4. **Представления (`news/views.py`):**
   - Обрабатывает запросы на загрузку JSON-файла, добавление статьи и редактирование статьи из JSON-файла.
   - Использует функцию `save_article` для сохранения статьи и генерации уникального `slug`.

**commit: `Урок 23: потоковое добавление статей теперь поддерживает редактирование`**

- файл для потоковой загрузки новостей (может понадобиться добавление новых тегов и категорий)

**commit: `Урок 23: файл с новостями`**