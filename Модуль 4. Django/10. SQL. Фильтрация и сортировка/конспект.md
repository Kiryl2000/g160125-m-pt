# Урок 10. SQL. Фильтрация и сортировка

### Возможности по фильтрации и сортировке

- **Цель урока:** Научить студентов выполнять фильтрацию и сортировку данных в SQL и Django ORM.
- **Результаты обучения:** Владение синтаксисом для фильтрации и сортировки данных. Умение фильтровать и сортировать записи через SQL и ORM.
- **Зачем нужна фильтрация и сортировка:**
  - **Фильтрация:** Позволяет выбирать только те данные, которые соответствуют определенным критериям. Это полезно для поиска конкретной информации в больших наборах данных. Например, если у вас есть база данных с миллионами записей, фильтрация поможет быстро найти нужные данные.
  - **Сортировка:** Позволяет упорядочить данные по определенным критериям. Это полезно для анализа данных, создания отчетов и улучшения пользовательского опыта. Например, сортировка по дате публикации поможет пользователям видеть самые свежие новости.

- **Основные темы и понятия:**
  - Возможности по фильтрации и сортировке.
  - Синтаксические конструкции для фильтрации и сортировки.
  - Написание запросов для фильтрации и сортировки.
  - Запросы через ORM и SQL.

- **Понимание методов сортировки и фильтрации данных:**
  - **Фильтрация:** Выборка данных по определенным критериям. Например, выборка всех статей, опубликованных в определенной категории.
  - **Сортировка:** Упорядочивание данных по определенным критериям. Например, сортировка статей по количеству просмотров.
- **Примеры использования фильтрации и сортировки в реальных задачах:**
  - **Интернет-магазин:** Фильтрация товаров по категориям, ценам, брендам и т.д. Сортировка товаров по популярности, цене, рейтингу и т.д.
  - **Социальные сети:** Фильтрация постов по хештегам, пользователям, дате публикации. Сортировка постов по количеству лайков, комментариев, дате публикации и т.д.
  - **Аналитика:** Фильтрация данных по определенным критериям для создания отчетов. Сортировка данных для анализа трендов и выявления закономерностей.

### Синтаксические конструкции для фильтрации и сортировки

- **Команды WHERE (OR, AND, IN, NOT):**
  - **WHERE:** Основная команда для фильтрации данных.
  - **OR:** Оператор для объединения нескольких условий, где достаточно выполнения хотя бы одного из них.
  - **AND:** Оператор для объединения нескольких условий, где должны выполняться все условия одновременно.
  - **IN:** Оператор для проверки наличия значения в списке значений.
  - **NOT:** Оператор для инверсии условия.
- **ORDER BY:** Команда для сортировки данных по одному или нескольким столбцам.
- **WITH:** Команда для создания временных таблиц или представлений.
- **Условия и операторы сравнения:** Основные операторы сравнения (=, <>, <, >, <=, >=) и логические операторы (AND, OR, NOT).

### Написание запросов для фильтрации и сортировки

- **Шаблон для SQL-запросов:**
  - **Шаблон для фильтрации:**
    ```sql
    SELECT column1, column2, ...
    FROM table_name
    WHERE condition;
    ```
  - **Шаблон для сортировки:**
    ```sql
    SELECT column1, column2, ...
    FROM table_name
    ORDER BY column1 [ASC|DESC], column2 [ASC|DESC], ...;
    ```
  - **Шаблон для фильтрации и сортировки:**
    ```sql
    SELECT column1, column2, ...
    FROM table_name
    WHERE condition
    ORDER BY column1 [ASC|DESC], column2 [ASC|DESC], ...;
    ```

- **Шаблон для Django ORM:**
  - **Шаблон для фильтрации:**
    ```python
    Model.objects.filter(condition)
    ```
  - **Шаблон для сортировки:**
    ```python
    Model.objects.order_by('field1', 'field2', ...)
    ```
  - **Шаблон для фильтрации и сортировки:**
    ```python
    Model.objects.filter(condition).order_by('field1', 'field2', ...)
    ```

### Запросы через ORM и SQL

- **Методы и инструменты:**
  - **SQL-конструкции для фильтрации и сортировки данных:**
    - **WHERE:** Основная команда для фильтрации данных.
    - **ORDER BY:** Команда для сортировки данных.
    - **AND, OR, NOT:** Логические операторы для объединения условий.
    - **IN:** Оператор для проверки наличия значения в списке значений.
    - **Условия и операторы сравнения:** Основные операторы сравнения (=, <>, <, >, <=, >=).

- **Разница между SQL и ORM:**
  - **SQL:** Язык запросов для работы с базами данных. Позволяет выполнять сложные запросы с использованием различных операторов и функций.
  - **ORM:** Объектно-реляционное отображение, которое позволяет работать с базой данных через объекты и методы программирования. Упрощает выполнение стандартных операций с базой данных.
- **Примеры сложных условий фильтрации и как они упрощаются в ORM:**
  - **SQL:** Требует написания сложных запросов с использованием различных операторов и функций.
  - **ORM:** Позволяет использовать методы и классы для упрощения написания запросов. Например, использование Q-класса для объединения условий.

- **Использование AND в Django ORM:**
  - **Использование Q-класса для объединения условий с оператором &:**
    ```python
    from django.db.models import Q
    articles = Article.objects.filter(Q(category_id=1) & Q(views__gt=100))
    ```
  - Этот запрос выбирает все статьи, где `category_id` равен 1 и количество просмотров больше 100, используя Django ORM и Q-класс для объединения условий с оператором &.

- **Примеры использования фильтрации и сортировки в реальных задачах:**
  - **Пример использования фильтрации и сортировки в реальных задачах:**
    ```sql
    SELECT * FROM news_article
    WHERE category_id = 1 AND views > 100
    ORDER BY views DESC;
    ```
  - Этот запрос выбирает все статьи, где `category_id` равен 1 и количество просмотров больше 100, и сортирует их по количеству просмотров в порядке убывания.

- **Примеры использования фильтрации и сортировки в реальных задачах в Django ORM:**
  - **Пример использования фильтрации и сортировки в реальных задачах:**
    ```python
    articles = Article.objects.filter(category_id=1, views__gt=100).order_by('-views')
    ```
  - Этот запрос выбирает все статьи, где `category_id` равен 1 и количество просмотров больше 100, и сортирует их по количеству просмотров в порядке убывания, используя Django ORM.

### Вопросы и ответы

- **Вопросы для студентов по пройденной теме:**
  1. Какие основные команды используются для фильтрации данных в SQL?
  2. Как можно объединить несколько условий в одном запросе в SQL?
  3. Как можно отсортировать данные по нескольким столбцам в SQL?
  4. Какие методы используются для фильтрации данных в Django ORM?
  5. Как можно объединить несколько условий в одном запросе в Django ORM?
  6. Как можно отсортировать данные по нескольким полям в Django ORM?
  7. В чем разница между использованием SQL и ORM для фильтрации и сортировки данных?
  8. Какие преимущества и недостатки есть у использования ORM по сравнению с SQL?
  9. Приведите пример сложного запроса с фильтрацией и сортировкой в SQL.
  10. Приведите пример сложного запроса с фильтрацией и сортировкой в Django ORM.

### Когда и почему лучше использовать SQL

1. **Сложные запросы и оптимизация:**
   - **Сложные запросы:** SQL позволяет писать сложные запросы с использованием подзапросов, объединений (JOIN), агрегатных функций и других мощных инструментов. Это особенно полезно для аналитических запросов и отчетов.
     ```sql
     SELECT a.title, COUNT(b.id) as comment_count
     FROM news_article a
     LEFT JOIN news_comment b ON a.id = b.article_id
     GROUP BY a.id
     HAVING comment_count > 10;
     ```
   - **Оптимизация:** SQL предоставляет больше контроля над оптимизацией запросов. Вы можете использовать индексы, оптимизировать планы выполнения запросов и выполнять другие действия для улучшения производительности.

2. **Производительность:**
   - **Высокая производительность:** SQL-запросы могут быть оптимизированы для выполнения на уровне базы данных, что может значительно улучшить производительность по сравнению с ORM, особенно для больших объемов данных.
     ```sql
     SELECT * FROM news_article
     WHERE category_id = 1 AND views > 100
     ORDER BY views DESC;
     ```
   - **Минимизация накладных расходов:** SQL-запросы могут быть написаны так, чтобы минимизировать накладные расходы на передачу данных между базой данных и приложением.

3. **Гибкость и контроль:**
   - **Полный контроль:** SQL предоставляет полный контроль над тем, как данные извлекаются и обрабатываются. Это полезно для сложных сценариев, где требуется точное управление данными.
   - **Гибкость:** SQL позволяет выполнять любые операции, поддерживаемые базой данных, включая создание временных таблиц, использование хранимых процедур и триггеров.
     ```sql
     WITH popular_articles AS (
         SELECT * FROM news_article WHERE views > 100
     )
     SELECT * FROM popular_articles WHERE category_id = 1;
     ```

4. **Совместимость:**
   - **Совместимость с различными базами данных:** SQL-запросы могут быть написаны так, чтобы быть совместимыми с различными системами управления базами данных (СУБД), что полезно для миграции данных или работы с несколькими СУБД.

### Когда и почему лучше использовать Django ORM

1. **Простота и удобство:**
   - **Простота:** Django ORM предоставляет удобный и интуитивно понятный интерфейс для работы с базой данных. Это упрощает написание запросов и снижает вероятность ошибок.
     ```python
     articles = Article.objects.filter(category_id=1, views__gt=100).order_by('-views')
     ```
   - **Удобство:** ORM позволяет работать с данными как с объектами Python, что делает код более читаемым и поддерживаемым.

2. **Безопасность:**
   - **Защита от SQL-инъекций:** Django ORM автоматически экранирует входные данные, что защищает от SQL-инъекций и других уязвимостей безопасности.
   - **Абстракция:** ORM абстрагирует детали работы с базой данных, что позволяет разработчикам сосредоточиться на бизнес-логике приложения.

3. **Производительность разработки:**
   - **Быстрая разработка:** ORM позволяет быстро писать и тестировать запросы, что ускоряет процесс разработки.
   - **Автоматическая генерация SQL:** ORM автоматически генерирует SQL-запросы, что снижает необходимость вручную писать и оптимизировать запросы.
     ```python
     from django.db.models import Q
     articles = Article.objects.filter(Q(category_id=1) & Q(views__gt=100))
     ```

4. **Совместимость с Django:**
   - **Интеграция:** Django ORM хорошо интегрируется с другими компонентами Django, такими как формы, админка и шаблоны. Это упрощает разработку полноценных веб-приложений.
   - **Миграции:** Django ORM поддерживает миграции, что упрощает управление изменениями в структуре базы данных.

5. **Поддержка сложных отношений:**
   - **Отношения:** ORM упрощает работу с сложными отношениями между таблицами, такими как один-ко-многим, многие-ко-многим и один-к-одному.
   - **Автоматическое управление:** ORM автоматически управляет внешними ключами и другими отношениями, что снижает вероятность ошибок.
     ```python
     articles = Article.objects.filter(category__name='Technology').order_by('-publication_date')
     ```

### Заключение

- **Выбор между SQL и ORM:** Выбор между SQL и ORM зависит от конкретных требований проекта. SQL предоставляет больше контроля и гибкости для сложных и оптимизированных запросов, тогда как ORM упрощает разработку и повышает безопасность. В большинстве случаев рекомендуется использовать ORM для стандартных операций и SQL для сложных и оптимизированных запросов.

### Вопросы и ответы

- **Вопросы для студентов по пройденной теме:**

1. **Какие основные команды используются для фильтрации данных в SQL?**
   - **Ответ:** Основные команды для фильтрации данных в SQL включают `WHERE`, `AND`, `OR`, `IN`, `NOT`.

2. **Как можно объединить несколько условий в одном запросе в SQL?**
   - **Ответ:** В SQL можно объединить несколько условий с помощью логических операторов `AND` и `OR`. Например:
     ```sql
     SELECT * FROM news_article WHERE category_id = 1 AND views > 100;
     ```

3. **Как можно отсортировать данные по нескольким столбцам в SQL?**
   - **Ответ:** В SQL можно отсортировать данные по нескольким столбцам с помощью команды `ORDER BY`. Например:
     ```sql
     SELECT * FROM news_article ORDER BY category_id ASC, publication_date DESC;
     ```

4. **Какие методы используются для фильтрации данных в Django ORM?**
   - **Ответ:** В Django ORM для фильтрации данных используются методы `filter` и `exclude`. Например:
     ```python
     articles = Article.objects.filter(category_id=1, views__gt=100)
     ```

5. **Как можно объединить несколько условий в одном запросе в Django ORM?**
   - **Ответ:** В Django ORM можно объединить несколько условий с помощью Q-объектов и логических операторов `&` и `|`. Например:
     ```python
     from django.db.models import Q
     articles = Article.objects.filter(Q(category_id=1) & Q(views__gt=100))
     ```

6. **Как можно отсортировать данные по нескольким полям в Django ORM?**
   - **Ответ:** В Django ORM можно отсортировать данные по нескольким полям с помощью метода `order_by`. Например:
     ```python
     articles = Article.objects.order_by('category_id', '-publication_date')
     ```

7. **В чем разница между использованием SQL и ORM для фильтрации и сортировки данных?**
   - **Ответ:** SQL предоставляет больше контроля и гибкости для сложных и оптимизированных запросов, тогда как ORM упрощает разработку и повышает безопасность. ORM позволяет работать с данными как с объектами Python, что делает код более читаемым и поддерживаемым.

8. **Какие преимущества и недостатки есть у использования ORM по сравнению с SQL?**
   - **Ответ:**
     - **Преимущества ORM:**
       - Простота и удобство использования.
       - Защита от SQL-инъекций.
       - Быстрая разработка и тестирование запросов.
       - Интеграция с другими компонентами Django.
       - Поддержка миграций.
     - **Недостатки ORM:**
       - Меньше контроля над оптимизацией запросов.
       - Может быть менее эффективен для сложных запросов.
       - Ограниченная гибкость по сравнению с SQL.

9. **Приведите пример сложного запроса с фильтрацией и сортировкой в SQL.**
   - **Ответ:** Пример сложного запроса с фильтрацией и сортировкой в SQL:
     ```sql
     SELECT * FROM news_article
     WHERE category_id IN (1, 2) AND views > 100
     ORDER BY publication_date DESC;
     ```

10. **Приведите пример сложного запроса с фильтрацией и сортировкой в Django ORM.**
    - **Ответ:** Пример сложного запроса с фильтрацией и сортировкой в Django ORM:
      ```python
      from django.db.models import Q
      articles = Article.objects.filter(Q(category_id=1) | Q(category_id=2), views__gt=100).order_by('-publication_date')
      ```