## Урок 27

### Добавление пользователя в описание карточки
- добавили автора в модель данных `Article` `author = models.ForeignKey(get_user_model(), on_delete=models.SET_NULL, null=True, default=None, verbose_name=_('Автор'))`
- Добавили пользователя в шаблоны отображения статей
- Модифицировали `AddArticleView` для добавления карточки, чтобы автором был текущий пользователь

**commit: `Урок 27: добавил пользователя в описание карточки`**

- `class LogoutUser(LogoutView): next_page = reverse_lazy('users:login')`
- Поправили `urls.py` для приложения `users` c использованием класса `LogoutUser`

Ошибка `Method Not Allowed (GET): /users/logout/` возникает, потому что представление `LogoutView` в `Django` по умолчанию обрабатывает только `POST`-запросы для выхода из системы.
Это сделано для повышения безопасности, чтобы предотвратить случайный выход пользователя из системы при переходе по ссылке.
Чтобы исправить эту ошибку, нужно изменить шаблон, чтобы отправлять `POST`-запрос при выходе из системы.
```html
<form method="post" action="{% url 'users:logout' %}">
    {% csrf_token %}
    <button type="submit" class="btn btn-link nav-link">Выйти</button>
</form>
```

**commit: `Урок 27: LogoutUser(LogoutView)`**

**Описание:**  
Добавлена функциональность регистрации пользователя с использованием формы `RegisterUserForm`. В рамках данного коммита реализованы следующие изменения:

1. **Добавлена форма регистрации (`RegisterUserForm`)**  
   - Создан новый класс `RegisterUserForm`, наследуемый от `forms.ModelForm`.
   - Поля формы: `username`, `email`, `first_name`, `password`, `password2`.
   - Добавлена валидация:
     - Проверка совпадения паролей.
     - Проверка уникальности `email`.

2. **Обновлен шаблон `register.html`**  
   - Теперь он расширяет `base.html` и использует `Bootstrap 5`.
   - Форма отображается в контейнере с адаптивной версткой.
   - Добавлен `CSRF`-токен.
   - Используется `{% block content %}` для интеграции в общий шаблон.

3. **Добавлен `register_done.html`**  
   - Шаблон с сообщением о завершении регистрации.

4. **Добавлено представление `sign_up` (FBV)**  
   - При `POST`-запросе создается объект пользователя с хешированным паролем.
   - После успешной регистрации происходит редирект на страницу `register_done`.
   - При `GET`-запросе отображается форма регистрации.

5. **Добавлено представление `RegisterDoneView` (CBV)**  
   - Использует `TemplateView` для отображения страницы успешной регистрации.
   - Наследуется от `LoginRequiredMixin`, чтобы предотвратить доступ незарегистрированных пользователей.
   - В `extra_context` передается заголовок страницы.

6. **Обновлен `users/urls.py`**  
   - Добавлен маршрут `register_done/` для отображения страницы завершения регистрации.

### Итог  
Этот коммит добавляет полную поддержку регистрации пользователей, включая валидацию, шаблоны и маршруты, обеспечивая удобный процесс регистрации.
  
**commit: `Урок 27: регистрация пользователя`**

Класс регистрации пользователя `RegisterUser`
- Переписали функцию регистрации на класс `RegisterUser(CreateView)` — специализированного родителя нет, поэтому используем `CreateView`
- Поправили `urls.py` для приложения `users` c использованием класса `RegisterUser`

**commit: `Урок 27: класс регистрации пользователя RegisterUser`**

- Переписали старую форму на класс `RegisterUserForm(UserCreationForm)` — специализированный родитель для регистрации пользователя
- Протестировали хеширование пароля (Есть!)

**commit: `Урок 27: форма регистрации пользователя RegisterUserForm`**

### Авторизация опционально через email или username

- Создаем файл бэкенда аутентификации `users/authentication.py`
- Определяем в нем собственный бэкенд
- Подключаем его в настройках `AUTHENTICATION_BACKENDS`
- Указываем там стандартный бэкенд `django.contrib.auth.backends.ModelBackend` и наш собственный `users.authentication.EmailAuthBackend`
- Поправили форму входа `LoginUserForm` (подпись, что вы можете войти по `email` или `username`)

**commit: `Урок 27: авторизация опционально через email или username`**